
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Ausstellung ‚Äì Werk</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="page">
    <main class="wrap">
      <img class="top-logo" src="logo.jpg" alt="Flu Logo" onerror="this.style.display='none'">
      <h1 id="ort">Ausstellungsort</h1>
      <div class="sub" id="ausstellungDatum">Titel ¬∑ Datum</div>
      <h2 id="werkSerie">Werk + Serie</h2>

      <div class="actions">
        <button class="btn" id="audio-open" type="button">üéß Audio abspielen</button>
        <button class="btn" id="pdf-link" type="button">üìÑ PDF anzeigen</button>
        <button class="btn" id="video-link" type="button">‚ñ∂Ô∏é Meine Arbeitsweise</button>
        <a class="btn" href="https://www.flu.ruhr/uber" target="_blank" rel="noopener">‚ÑπÔ∏è Info K√ºnstler</a>
        <a id="audio-link" href="#" style="display:none" aria-hidden="true" tabindex="-1">hidden</a>
      </div>

      <p class="note">Bitte Kopfh√∂rer verwenden oder die Lautst√§rke so w√§hlen,<br> dass andere Besucher nicht gest√∂rt werden.</p>
    </main>
  </div>

  <footer class="footer">
    <div class="brand"><a href="https://www.flu.ruhr" target="_blank" rel="noopener">www.flu.ruhr</a></div>
    <div>¬© 2025 Flu ‚Äì New Fine Art</div>
  </footer>

  <!-- PDF Modal -->
  <div class="modal" id="pdfModal" aria-hidden="true">
    <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="pdfTitle">
      <div class="dialog-hd">
        <div class="dialog-ttl" id="pdfTitle">PDF: Werk</div>
        <div class="dialog-actions">
          <a class="m-btn" id="pdfNewTab" href="#" target="_blank" rel="noopener">In neuem Tab</a>
          <button class="m-btn" id="closePdf" type="button">Schlie√üen</button>
        </div>
      </div>
      <div class="dialog-body">
        <div id="pdfLoader" class="loader" role="status" aria-live="polite">
          <div>
            <div class="spinner" aria-hidden="true"></div>
            <div class="loader-text">PDF wird geladen ‚Ä¶</div>
          </div>
        </div>
        <iframe class="pdfjs-frame" id="pdfFrame" allowfullscreen></iframe>
      </div>
    </div>
  </div>

  <!-- Video Modal -->
  <div class="modal" id="videoModal" aria-hidden="true">
    <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="videoTitle">
      <div class="dialog-hd">
        <div class="dialog-ttl" id="videoTitle">Meine Arbeitsweise</div>
        <div class="dialog-actions">
          <button class="m-btn" id="closeVideo" type="button">Schlie√üen</button>
        </div>
      </div>
      <div class="dialog-body">
        <iframe id="videoFrame"
                src="" title="YouTube Video Player"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                allowfullscreen></iframe>
      </div>
    </div>
  </div>

  <!-- Audio Modal -->
  <div class="modal" id="audioModal" aria-hidden="true">
    <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="audioTitle">
      <div class="dialog-hd">
        <div class="dialog-ttl" id="audioTitle">Audiobeschreibung</div>
        <div class="dialog-actions">
          <button class="m-btn" id="closeAudio" type="button">Schlie√üen</button>
        </div>
      </div>
      <div class="dialog-body">
        <audio id="audioPlayer" controls preload="metadata">
          <source id="audioSource" src="" type="audio/mpeg">
          Dein Browser unterst√ºtzt das Audio-Element nicht.
        </audio>
      </div>
    </div>
  </div>

  <script src="werke.js"></script>
  <script>
    const GLOBAL_VIDEO_EMBED = "https://www.youtube.com/embed/_Yg0ta6Lk9w?rel=0";
    const qs = s => document.querySelector(s);

    function openModal(m){ m.classList.add('open'); m.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden'; }
    function closeModal(m){ m.classList.remove('open'); m.setAttribute('aria-hidden','true'); document.body.style.overflow=''; }

    async function getCurrentWerk(){
      const id = new URLSearchParams(location.search).get("id");
      const fromWindow = (window.WERKE||[]).find(w => String(w.id) === String(id));
      if (fromWindow) return fromWindow;
      try {
        const res = await fetch('works.json', {cache:'no-store'});
        const list = await res.json();
        return (list||[]).find(w => String(w.id) === String(id)) || null;
      } catch(e){ return null; }
    }

    document.addEventListener('DOMContentLoaded', () => {
      // PDF
      const pdfModal = qs('#pdfModal'), pdfBtn=qs('#pdf-link'), pdfFrame=qs('#pdfFrame'),
            pdfNewTab=qs('#pdfNewTab'), pdfTitle=qs('#pdfTitle'), closePdf=qs('#closePdf'),
            pdfLoader=qs('#pdfLoader');

      const hidePdfLoader = () => { pdfLoader.classList.add('hidden'); };

      pdfBtn?.addEventListener('click', async () => {
        const werk = await getCurrentWerk();
        if (!werk || !werk.pdf) return;
        // Reset loader + frame
        pdfLoader.classList.remove('hidden');
        pdfFrame.removeAttribute('src');

        const pdfUrl = (location.origin + '/' + werk.pdf).replace(/\/+/, '/');
        const viewerUrl = "https://mozilla.github.io/pdf.js/web/viewer.html?file=" + encodeURIComponent(pdfUrl);
        pdfFrame.src = viewerUrl;
        pdfNewTab.href = '/' + werk.pdf;
        pdfTitle.textContent = "PDF: " + (werk.werk || 'Werk');
        openModal(pdfModal);
      });

      // hide loader once iframe is ready (use both load & a timeout fallback)
      pdfFrame?.addEventListener('load', hidePdfLoader);
      setInterval(() => {
        // if the viewer puts contentDocument, hide loader (coarse check to avoid leaving spinner)
        try {
          if (pdfFrame.contentWindow && pdfFrame.contentDocument && pdfFrame.contentDocument.readyState !== 'loading') {
            hidePdfLoader();
          }
        } catch(e){}
      }, 800);

      closePdf?.addEventListener('click', () => {
        closeModal(pdfModal);
        pdfFrame.src = "";
      });
      pdfModal?.addEventListener('click', (e)=>{
        if(e.target===pdfModal){
          closeModal(pdfModal);
          pdfFrame.src="";
        }
      });

      // Video
      const videoBtn=qs('#video-link'), videoModal=qs('#videoModal'), videoFrame=qs('#videoFrame'), closeVideo=qs('#closeVideo');
      videoBtn?.addEventListener('click', () => { videoFrame.src = GLOBAL_VIDEO_EMBED; openModal(videoModal); });
      closeVideo?.addEventListener('click', () => { closeModal(videoModal); videoFrame.src = ""; });
      videoModal?.addEventListener('click', (e) => { if (e.target === videoModal) { closeModal(videoModal); videoFrame.src = ""; } });

      // Audio
      const audioOpen=qs('#audio-open'), audioModal=qs('#audioModal'), audioPlayer=qs('#audioPlayer'),
            audioSource=qs('#audioSource'), closeAudio=qs('#closeAudio');

      audioOpen?.addEventListener('click', async (e) => {
        e.preventDefault();
        const existingLink = document.getElementById('audio-link');
        let url = existingLink && existingLink.href ? existingLink.href : "";
        if (!url){
          const werk = await getCurrentWerk();
          if (werk && werk.audio) url = '/' + werk.audio;
        }
        if (url) {
          audioSource.src = url;
          audioPlayer.load();
          try { await audioPlayer.play(); } catch {}
        }
        openModal(audioModal);
      });
      closeAudio?.addEventListener('click', () => { audioPlayer.pause(); audioPlayer.currentTime = 0; closeModal(audioModal); });
      audioModal?.addEventListener('click', (e) => { if (e.target === audioModal) { audioPlayer.pause(); audioPlayer.currentTime = 0; closeModal(audioModal); } });

      // ESC schlie√üt
      document.addEventListener('keydown', (ev)=>{
        if (ev.key === 'Escape') {
          [pdfModal, videoModal, audioModal].forEach(m => {
            if (m && m.classList.contains('open')) {
              if (m===videoModal) { videoFrame.src=""; }
              if (m===audioModal) { audioPlayer.pause(); audioPlayer.currentTime=0; }
              if (m===pdfModal)   { pdfFrame.src=""; }
              closeModal(m);
            }
          });
        }
      });
    });
  </script>
</body>
</html>
